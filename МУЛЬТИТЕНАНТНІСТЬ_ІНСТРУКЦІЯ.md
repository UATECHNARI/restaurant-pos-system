# üîê –ú–£–õ–¨–¢–ò–¢–ï–ù–ê–ù–¢–ù–Ü–°–¢–¨ (Multi-tenancy) - –Ü–ù–°–¢–†–£–ö–¶–Ü–Ø

## üéØ –©–æ —Ü–µ –æ–∑–Ω–∞—á–∞—î:

**–ö–æ–∂–µ–Ω –∫–ª—ñ—î–Ω—Ç (–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä) –º–∞—î —Å–≤–æ—é –æ–∫—Ä–µ–º—É –±–∞–∑—É –¥–∞–Ω–∏—Ö:**
- ‚úÖ –°–≤–æ—ó —Ç–æ–≤–∞—Ä–∏ (products)
- ‚úÖ –°–≤–æ—ó —Å—Ç–æ–ª–∏ (tables)
- ‚úÖ –°–≤–æ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (orders)
- ‚úÖ –°–≤–æ—ó—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (users) –∑ —Ä–æ–ª—è–º–∏ (–∫—É—Ö–Ω—è, –±–∞—Ä, –∫–∞—Å–∞)
- ‚úÖ –ü–æ–≤–Ω–∞ —ñ–∑–æ–ª—è—Ü—ñ—è –¥–∞–Ω–∏—Ö –º—ñ–∂ –∫–ª—ñ—î–Ω—Ç–∞–º–∏

---

## üìã –©–û –ë–£–õ–û –ó–†–û–ë–õ–ï–ù–û:

### 1. **–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö:**

#### –°—Ç–≤–æ—Ä–µ–Ω–æ —Ç–∞–±–ª–∏—Ü—é `clients`:
- `id` - ID –∫–ª—ñ—î–Ω—Ç–∞
- `name` - –ù–∞–∑–≤–∞ –∫–ª—ñ—î–Ω—Ç–∞ (—Ä–µ—Å—Ç–æ—Ä–∞–Ω—É)
- `email` - Email –∫–ª—ñ—î–Ω—Ç–∞
- `phone` - –¢–µ–ª–µ—Ñ–æ–Ω (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
- `address` - –ê–¥—Ä–µ—Å–∞ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
- `status` - –°—Ç–∞—Ç—É—Å (active, suspended, inactive)

#### –î–æ–¥–∞–Ω–æ `client_id` –≤ —É—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ:
- ‚úÖ `users` - –∑–≤'—è–∑–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏
- ‚úÖ `products` - —Ç–æ–≤–∞—Ä–∏ –Ω–∞–ª–µ–∂–∞—Ç—å –∫–ª—ñ—î–Ω—Ç—É
- ‚úÖ `tables` - —Å—Ç–æ–ª–∏ –Ω–∞–ª–µ–∂–∞—Ç—å –∫–ª—ñ—î–Ω—Ç—É
- ‚úÖ `orders` - –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–µ–∂–∞—Ç—å –∫–ª—ñ—î–Ω—Ç—É
- ‚úÖ `order_items` - –ø–æ–∑–∏—Ü—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–µ–∂–∞—Ç—å –∫–ª—ñ—î–Ω—Ç—É
- ‚úÖ `activity_logs` - –ª–æ–≥–∏ –Ω–∞–ª–µ–∂–∞—Ç—å –∫–ª—ñ—î–Ω—Ç—É

#### Foreign Keys:
- –í—Å—ñ `client_id` –º–∞—é—Ç—å FOREIGN KEY –Ω–∞ `clients(id)`
- –ü—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞ - –≤—Å—ñ –¥–∞–Ω—ñ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ (CASCADE)

---

### 2. **Backend:**

#### –û–Ω–æ–≤–ª–µ–Ω–æ `authController.js`:
- –ü—Ä–∏ **—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó** —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è:
  1. –ó–∞–ø–∏—Å –≤ `clients` (–∫–ª—ñ—î–Ω—Ç)
  2. –ó–∞–ø–∏—Å –≤ `users` –∑ `client_id` —Ç–∞ —Ä–æ–ª–ª—é `admin`
  3. JWT —Ç–æ–∫–µ–Ω –º—ñ—Å—Ç–∏—Ç—å `client_id`

- –ü—Ä–∏ **–ª–æ–≥—ñ–Ω—ñ**:
  - JWT —Ç–æ–∫–µ–Ω –º—ñ—Å—Ç–∏—Ç—å `client_id` –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  - `getProfile` –ø–æ–≤–µ—Ä—Ç–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞

#### –°—Ç–≤–æ—Ä–µ–Ω–æ `clientMiddleware.js`:
- `getClientId(req)` - –æ—Ç—Ä–∏–º–∞—Ç–∏ `client_id` –∑ JWT
- `requireClientId(req, res, next)` - middleware –¥–ª—è –≤–∏–º–æ–≥–∏ `client_id`
- `addClientId(req, res, next)` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—î `req.client_id`

#### –û–Ω–æ–≤–ª–µ–Ω–æ –≤—Å—ñ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏:

**`productsController.js`:**
- –í—Å—ñ –∑–∞–ø–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä—É—é—Ç—å—Å—è –ø–æ `client_id`
- `getAllProducts` - —Ç—ñ–ª—å–∫–∏ —Ç–æ–≤–∞—Ä–∏ –∫–ª—ñ—î–Ω—Ç–∞
- `createProduct` - —Å—Ç–≤–æ—Ä—é—î —Ç–æ–≤–∞—Ä –∑ `client_id`
- `updateProduct` / `deleteProduct` - —Ç—ñ–ª—å–∫–∏ —Ç–æ–≤–∞—Ä–∏ –∫–ª—ñ—î–Ω—Ç–∞

**`usersController.js`:**
- `getAllUsers` - —Ç—ñ–ª—å–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∫–ª—ñ—î–Ω—Ç–∞
- `createUser` - —Å—Ç–≤–æ—Ä—é—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ `client_id` –∞–¥–º—ñ–Ω–∞
- –õ–æ–≥—ñ–Ω–∏ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è —É–Ω—ñ–∫–∞–ª—å–Ω–æ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞

**`tablesController.js`, `ordersController.js`:**
- –ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É—é—Ç—å—Å—è –ø–æ `client_id`

---

## üöÄ –ö–†–û–ö–ò –î–õ–Ø –ó–ê–°–¢–û–°–£–í–ê–ù–ù–Ø:

### 1Ô∏è‚É£ –û–Ω–æ–≤–∏—Ç–∏ –±–∞–∑—É –¥–∞–Ω–∏—Ö:

```sql
-- –í—ñ–¥–∫—Ä–∏—Ç–∏ MySQL Workbench –∞–±–æ –∫–æ–º–∞–Ω–¥–Ω–∏–π —Ä—è–¥–æ–∫
-- –í–∏–∫–æ–Ω–∞—Ç–∏ —Ñ–∞–π–ª: D:\Work\Pizza\backend\add-multi-tenancy.sql
```

**–ê–±–æ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω–∏–π —Ä—è–¥–æ–∫:**
```powershell
cd D:\Work\Pizza\backend
mysql -u root -p < add-multi-tenancy.sql
```

### 2Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ backend:

```powershell
cd D:\Work\Pizza\backend
npm run dev
```

### 3Ô∏è‚É£ –û–Ω–æ–≤–∏—Ç–∏ frontend (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ):

Frontend –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç—Ä–∏–º–∞—î `client_id` –∑ JWT —Ç–æ–∫–µ–Ω—É –ø—Ä–∏ –ª–æ–≥—ñ–Ω—ñ/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.

---

## üìù –ü–†–ò–ö–õ–ê–î –í–ò–ö–û–†–ò–°–¢–ê–ù–ù–Ø:

### 1. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞:

```
1. –ö–ª—ñ—î–Ω—Ç —Ä–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç—ñ
2. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑–∞–ø–∏—Å –≤ —Ç–∞–±–ª–∏—Ü—ñ `clients`
3. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ä–æ–ª–ª—é `admin` —Ç–∞ `client_id`
4. –ö–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î JWT —Ç–æ–∫–µ–Ω –∑ `client_id`
```

### 2. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤:

```
1. –ê–¥–º—ñ–Ω –∫–ª—ñ—î–Ω—Ç–∞ —Å—Ç–≤–æ—Ä—é—î —Ç–æ–≤–∞—Ä
2. Backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—î `client_id` –∑ JWT —Ç–æ–∫–µ–Ω—É
3. –¢–æ–≤–∞—Ä –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∑ `client_id` –∫–ª—ñ—î–Ω—Ç–∞
4. –Ü–Ω—à—ñ –∫–ª—ñ—î–Ω—Ç–∏ –Ω–µ –±–∞—á–∞—Ç—å —Ü–µ–π —Ç–æ–≤–∞—Ä
```

### 3. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (–∫—É—Ö–Ω—è, –±–∞—Ä, –∫–∞—Å–∞):

```
1. –ê–¥–º—ñ–Ω –∫–ª—ñ—î–Ω—Ç–∞ —Å—Ç–≤–æ—Ä—é—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ä–æ–ª–ª—é
2. Backend –¥–æ–¥–∞—î `client_id` –∞–¥–º—ñ–Ω–∞ –¥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
3. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏—Ç—å —Ç—ñ–ª—å–∫–∏ –¥–∞–Ω—ñ —Å–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
```

---

## üîê –ë–ï–ó–ü–ï–ö–ê:

1. ‚úÖ –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç —Ñ—ñ–ª—å—Ç—Ä—É—î—Ç—å—Å—è –ø–æ `client_id`
2. ‚úÖ –ù–µ–º–æ–∂–ª–∏–≤–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ —ñ–Ω—à–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
3. ‚úÖ JWT —Ç–æ–∫–µ–Ω –º—ñ—Å—Ç–∏—Ç—å `client_id`
4. ‚úÖ Foreign Keys –∑–∞–±–µ–∑–ø–µ—á—É—é—Ç—å —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö
5. ‚úÖ –ü—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞ - –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è –≤—Å—ñ –π–æ–≥–æ –¥–∞–Ω—ñ

---

## üìä –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ò–•:

```
clients (–∫–ª—ñ—î–Ω—Ç–∏)
  ‚îú‚îÄ‚îÄ id: 1 (–ö–ª—ñ—î–Ω—Ç 1)
  ‚îÇ   ‚îú‚îÄ‚îÄ users (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ)
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin (client_id: 1)
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kitchen1 (client_id: 1)
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bar1 (client_id: 1)
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cashier1 (client_id: 1)
  ‚îÇ   ‚îú‚îÄ‚îÄ products (—Ç–æ–≤–∞—Ä–∏)
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ü—ñ—Ü–∞ 1 (client_id: 1)
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –ù–∞–ø—ñ–π 1 (client_id: 1)
  ‚îÇ   ‚îú‚îÄ‚îÄ tables (—Å—Ç–æ–ª–∏)
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –°—Ç—ñ–ª 1-10 (client_id: 1)
  ‚îÇ   ‚îî‚îÄ‚îÄ orders (–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è)
  ‚îÇ       ‚îî‚îÄ‚îÄ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è 1-N (client_id: 1)
  ‚îÇ
  ‚îî‚îÄ‚îÄ id: 2 (–ö–ª—ñ—î–Ω—Ç 2)
      ‚îú‚îÄ‚îÄ users
      ‚îú‚îÄ‚îÄ products
      ‚îú‚îÄ‚îÄ tables
      ‚îî‚îÄ‚îÄ orders
      (–ø–æ–≤–Ω–∞ —ñ–∑–æ–ª—è—Ü—ñ—è –≤—ñ–¥ –ö–ª—ñ—î–Ω—Ç–∞ 1)
```

---

## ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û:

### –î–ª—è —ñ—Å–Ω—É—é—á–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:

–Ø–∫—â–æ —É –≤–∞—Å –≤–∂–µ —î –¥–∞–Ω—ñ –≤ –±–∞–∑—ñ, –ø–æ—Ç—Ä—ñ–±–Ω–æ —ó—Ö –º—ñ–≥—Ä—É–≤–∞—Ç–∏:

```sql
-- 1. –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
INSERT INTO clients (name, email, status) 
VALUES ('–¢–µ—Å—Ç–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç', 'test@client.com', 'active');

-- 2. –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —ñ—Å–Ω—É—é—á–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–æ –∫–ª—ñ—î–Ω—Ç–∞
UPDATE users SET client_id = 1 WHERE client_id IS NULL AND role != 'admin';

-- 3. –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —ñ—Å–Ω—É—é—á—ñ —Ç–æ–≤–∞—Ä–∏ –¥–æ –∫–ª—ñ—î–Ω—Ç–∞
UPDATE products SET client_id = 1 WHERE client_id IS NULL;

-- 4. –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —ñ—Å–Ω—É—é—á—ñ —Å—Ç–æ–ª–∏ –¥–æ –∫–ª—ñ—î–Ω—Ç–∞
UPDATE tables SET client_id = 1 WHERE client_id IS NULL;

-- 5. –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —ñ—Å–Ω—É—é—á—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –¥–æ –∫–ª—ñ—î–Ω—Ç–∞
UPDATE orders SET client_id = 1 WHERE client_id IS NULL;

-- 6. –û–Ω–æ–≤–∏—Ç–∏ order_items
UPDATE order_items oi
INNER JOIN orders o ON oi.order_id = o.id
SET oi.client_id = o.client_id
WHERE oi.client_id IS NULL;
```

---

## ‚úÖ –ì–û–¢–û–í–û!

–ü—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è SQL —Å–∫—Ä–∏–ø—Ç—É —Ç–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É backend:

1. ‚úÖ –ö–æ–∂–µ–Ω –Ω–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º–∞—î —Å–≤–æ—é —ñ–∑–æ–ª—å–æ–≤–∞–Ω—É –ë–î
2. ‚úÖ –¢–æ–≤–∞—Ä–∏, —Å—Ç–æ–ª–∏, –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—É—é—Ç—å—Å—è –ø–æ –∫–ª—ñ—î–Ω—Ç—É
3. ‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (–∫—É—Ö–Ω—è, –±–∞—Ä, –∫–∞—Å–∞) –±–∞—á–∞—Ç—å —Ç—ñ–ª—å–∫–∏ –¥–∞–Ω—ñ —Å–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
4. ‚úÖ –ü–æ–≤–Ω–∞ –±–µ–∑–ø–µ–∫–∞ —Ç–∞ —ñ–∑–æ–ª—è—Ü—ñ—è –¥–∞–Ω–∏—Ö

---

**–§–∞–π–ª SQL —Å–∫—Ä–∏–ø—Ç—É:** `D:\Work\Pizza\backend\add-multi-tenancy.sql`


